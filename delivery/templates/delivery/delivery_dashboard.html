{% extends 'base.html' %}
{% load static %}

{% block title %}Delivery Agent Dashboard - Foodify{% endblock %}

{% block content %}
<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 100px auto 60px;
        padding: 0 20px;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
    }

    .dashboard-header h1 {
        color: var(--text-main);
        margin: 0;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: var(--shadow-md);
    }

    .stat-card h3 {
        margin: 0 0 10px 0;
        font-size: 1rem;
        opacity: 0.9;
    }

    .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0;
    }

    .availability-toggle {
        display: flex;
        align-items: center;
        gap: 15px;
        background: white;
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
    }

    .availability-toggle label {
        font-weight: 600;
        margin: 0;
    }

    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 30px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked+.slider {
        background-color: var(--primary);
    }

    input:checked+.slider:before {
        transform: translateX(30px);
    }

    .orders-section {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: var(--shadow-md);
    }

    .orders-section h2 {
        margin-top: 0;
        color: var(--text-main);
    }

    .order-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s;
    }

    .order-card:hover {
        box-shadow: var(--shadow-md);
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .order-id {
        font-weight: bold;
        color: var(--text-main);
        font-size: 1.1rem;
    }

    .order-status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-pending {
        background: #fef3c7;
        color: #92400e;
    }

    .status-confirmed {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-preparing {
        background: #e0e7ff;
        color: #3730a3;
    }

    .status-out-for-delivery {
        background: #fce7f3;
        color: #9f1239;
    }

    .status-delivered {
        background: #d1fae5;
        color: #065f46;
    }

    .order-details {
        color: var(--text-muted);
        margin-bottom: 15px;
    }

    .order-details p {
        margin: 5px 0;
    }

    .order-actions {
        display: flex;
        gap: 10px;
    }

    .btn-small {
        padding: 8px 16px;
        font-size: 0.9rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-accept {
        background: #10b981;
        color: white;
    }

    .btn-accept:hover {
        background: #059669;
    }

    .btn-reject {
        background: #ef4444;
        color: white;
    }

    .btn-reject:hover {
        background: #dc2626;
    }

    .btn-update {
        background: var(--primary);
        color: white;
    }

    .btn-update:hover {
        background: var(--primary-dark);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>ðŸš´ Delivery Agent Dashboard</h1>
        <div class="availability-toggle">
            <label>Availability:</label>
            <label class="toggle-switch">
                <input type="checkbox" id="availability-toggle" {% if delivery_agent.availability_status %}checked{%
                    endif %} onchange="toggleAvailability()">
                <span class="slider"></span>
            </label>
            <span id="availability-text"
                style="font-weight: 600; color: {% if delivery_agent.availability_status %}var(--primary){% else %}#ef4444{% endif %}">
                {% if delivery_agent.availability_status %}Available{% else %}Not Available{% endif %}
            </span>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Deliveries</h3>
            <p class="stat-value">{{ total_deliveries }}</p>
        </div>
        <div class="stat-card">
            <h3>Total Earnings</h3>
            <p class="stat-value">â‚¹{{ total_earnings|floatformat:2 }}</p>
        </div>
        <div class="stat-card">
            <h3>Active Orders</h3>
            <p class="stat-value">{{ active_orders.count }}</p>
        </div>
        <div class="stat-card">
            <h3>Pending Orders</h3>
            <p class="stat-value">{{ pending_orders.count }}</p>
        </div>
    </div>

    <!-- Assigned Orders Section -->
    <div class="orders-section">
        <h2>ðŸ“¦ Assigned Orders</h2>

        {% if assigned_orders %}
        {% for order in assigned_orders %}
        <div class="order-card">
            <div class="order-header">
                <span class="order-id">Order #{{ order.id }}</span>
                <span class="order-status status-{{ order.status|slugify }}">{{ order.get_status_display }}</span>
            </div>
            <div class="order-details">
                <p><strong>Customer:</strong> {{ order.user.username }}</p>
                <p><strong>Restaurant:</strong> {{ order.restaurant.name }}</p>
                <p><strong>Delivery Address:</strong> {{ order.delivery_address }}</p>
                <p><strong>Total Amount:</strong> â‚¹{{ order.grand_total|floatformat:2 }}</p>
                <p><strong>Delivery Fee:</strong> â‚¹{{ order.delivery_fee|floatformat:2 }}</p>
                <p><strong>Ordered:</strong> {{ order.created_at|date:"d M Y, h:i A" }}</p>
            </div>
            <div class="order-actions">
                {% if order.status == 'confirmed' or order.status == 'preparing' %}
                <button class="btn-small btn-accept" onclick="acceptOrder({{ order.id }})">Accept Order</button>
                <button class="btn-small btn-reject" onclick="rejectOrder({{ order.id }})">Reject Order</button>
                {% elif order.status == 'out_for_delivery' %}
                <button class="btn-small btn-update" onclick="updateStatus({{ order.id }}, 'delivered')">Mark as
                    Delivered</button>
                {% elif order.status == 'delivered' %}
                <span style="color: #10b981; font-weight: 600;">âœ“ Delivered</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <h2>No Orders Assigned</h2>
            <p>You don't have any orders assigned yet. Check back later!</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function toggleAvailability() {
        fetch("{% url 'delivery:toggle_availability' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const statusText = document.getElementById('availability-text');
                    statusText.textContent = data.status ? 'Available' : 'Not Available';
                    statusText.style.color = data.status ? 'var(--primary)' : '#ef4444';
                    alert(data.message);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update availability status');
            });
    }

    function acceptOrder(orderId) {
        if (confirm('Accept this order?')) {
            fetch(`/delivery/order/${orderId}/accept/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to accept order');
                });
        }
    }

    function rejectOrder(orderId) {
        if (confirm('Reject this order? It will be unassigned from you.')) {
            fetch(`/delivery/order/${orderId}/reject/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to reject order');
                });
        }
    }

    function updateStatus(orderId, status) {
        if (confirm('Mark this order as delivered?')) {
            const formData = new FormData();
            formData.append('status', status);

            fetch(`/delivery/order/${orderId}/update-status/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update order status');
                });
        }
    }
</script>
{% endblock %}