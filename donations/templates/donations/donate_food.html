{% extends 'base.html' %}
{% load static %}

{% block title %}Donate Food - Foodify{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #FFF8F5 0%, #FFE0D6 100%);
        min-height: 100vh;
    }
    
    .donate-container {
        max-width: 1200px;
        margin: 100px auto 60px;
        padding: 0 20px;
    }
    
    .donate-header {
        text-align: center;
        margin-bottom: 50px;
    }
    
    .donate-header h1 {
        font-size: 3rem;
        color: #1f2937;
        margin-bottom: 15px;
    }
    
    .donate-header p {
        font-size: 1.2rem;
        color: #6b7280;
    }
    
    .donate-grid {
        display: grid;
        grid-template-columns: 1fr 450px;
        gap: 30px;
    }
    
    .form-card {
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    
    .form-section {
        margin-bottom: 35px;
    }
    
    .form-section h3 {
        font-size: 1.3rem;
        color: #1f2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: #374151;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-family: 'Poppins', sans-serif;
        font-size: 0.95rem;
        transition: all 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #FF6B00;
        box-shadow: 0 0 0 3px rgba(255,107,0,0.1);
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    .form-group small {
        display: block;
        margin-top: 5px;
        color: #6b7280;
        font-size: 0.85rem;
    }
    
    .map-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        position: sticky;
        top: 100px;
        height: fit-content;
    }
    
    #map {
        width: 100%;
        height: 400px;
    }
    
    .map-instructions {
        padding: 20px;
        background: #f9fafb;
    }
    
    .map-instructions h4 {
        font-size: 1.1rem;
        color: #1f2937;
        margin-bottom: 10px;
    }
    
    .map-instructions p {
        color: #6b7280;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .coordinates-display {
        background: #fff;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        font-family: monospace;
        font-size: 0.85rem;
        color: #FF6B00;
    }
    
    .submit-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #FF6B00 0%, #E55A00 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 20px;
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255,107,0,0.4);
    }
    
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
        position: absolute;
        left: -9999px;
    }
    
    .file-input-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px 16px;
        border: 2px dashed #e5e7eb;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        color: #6b7280;
    }
    
    .file-input-label:hover {
        border-color: #FF6B00;
        color: #FF6B00;
    }
    
    .file-name {
        margin-top: 8px;
        font-size: 0.85rem;
        color: #22c55e;
    }
    
    @media (max-width: 1024px) {
        .donate-grid {
            grid-template-columns: 1fr;
        }
        .map-card {
            position: static;
        }
    }
</style>

<div class="donate-container">
    <div class="donate-header">
        <h1>üéÅ Donate Food</h1>
        <p>Help reduce food waste and feed those in need</p>
    </div>
    
    <form method="POST" enctype="multipart/form-data" id="donationForm">
        {% csrf_token %}
        
        <div class="donate-grid">
            <!-- Form Section -->
            <div>
                <div class="form-card">
                    <!-- Food Details -->
                    <div class="form-section">
                        <h3>üçΩÔ∏è Food Details</h3>
                        
                        <div class="form-group">
                            <label>Food Name *</label>
                            {{ form.food_name }}
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Food Type *</label>
                                {{ form.food_type }}
                            </div>
                            
                            <div class="form-group">
                                <label>Category *</label>
                                {{ form.category }}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            {{ form.description }}
                            <small>Additional details about the food</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Food Image</label>
                            <div class="file-input-wrapper">
                                {{ form.image }}
                                <label for="id_image" class="file-input-label">
                                    üì∏ Click to upload image
                                </label>
                            </div>
                            <div class="file-name" id="fileName"></div>
                        </div>
                    </div>
                    
                    <!-- Quantity Details -->
                    <div class="form-section">
                        <h3>üì¶ Quantity Details</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Quantity *</label>
                                {{ form.original_quantity }}
                                <small>Number of servings/plates/portions</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Unit *</label>
                                {{ form.quantity_unit }}
                                <small>e.g., plates, servings, kg</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location Details -->
                    <div class="form-section">
                        <h3>üìç Pickup Location</h3>
                        
                        <div class="form-group">
                            <label>Address *</label>
                            {{ form.location }}
                            <small>Click on the map to set exact location</small>
                        </div>
                        
                        {{ form.latitude }}
                        {{ form.longitude }}
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Contact Name *</label>
                                {{ form.contact_name }}
                            </div>
                            
                            <div class="form-group">
                                <label>Phone Number *</label>
                                {{ form.contact_phone }}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Pickup Instructions</label>
                            {{ form.pickup_instructions }}
                            <small>Any special instructions for pickup</small>
                        </div>
                    </div>
                    
                    <!-- Timing Details -->
                    <div class="form-section">
                        <h3>‚è∞ Timing Information</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Prepared Time</label>
                                {{ form.prepared_time }}
                            </div>
                            
                            <div class="form-group">
                                <label>Best Before</label>
                                {{ form.expiry_time }}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Available Until</label>
                            {{ form.available_until }}
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn">
                        üéÅ Create Donation
                    </button>
                </div>
            </div>
            
            <!-- Map Section -->
            <div class="map-card">
                <div id="map"></div>
                <div class="map-instructions">
                    <h4>üìç Set Pickup Location</h4>
                    <p>Click on the map to set the exact pickup location. You can also search for an address and the map will update automatically.</p>
                    <div class="coordinates-display" id="coordsDisplay">
                        Lat: <span id="latDisplay">19.0760</span>, Lng: <span id="lngDisplay">72.8777</span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Load MapLibre GL JS and CSS
const mapScript = document.createElement('script');
mapScript.src = 'https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js';
document.head.appendChild(mapScript);

const mapCSS = document.createElement('link');
mapCSS.rel = 'stylesheet';
mapCSS.href = 'https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css';
document.head.appendChild(mapCSS);

// File upload handler
document.getElementById('id_image').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name || '';
    const fileNameDisplay = document.getElementById('fileName');
    if (fileName) {
        fileNameDisplay.textContent = `‚úÖ ${fileName}`;
    } else {
        fileNameDisplay.textContent = '';
    }
});

// Geoapify Map Integration
let map, marker;
const apiKey = '{{ geoapify_api_key }}';
const defaultLat = 19.0760;
const defaultLng = 72.8777;

mapScript.onload = function() {
    // Initialize map
    map = new maplibregl.Map({
        container: 'map',
        style: `https://maps.geoapify.com/v1/styles/osm-bright/style.json?apiKey=${apiKey}`,
        center: [defaultLng, defaultLat],
        zoom: 12
    });
    
    // Add navigation controls
    map.addControl(new maplibregl.NavigationControl());
    
    // Add default marker
    marker = new maplibregl.Marker({ color: '#FF6B00', draggable: true })
        .setLngLat([defaultLng, defaultLat])
        .addTo(map);
    
    // Update coordinates when marker is dragged
    marker.on('dragend', function() {
        const lngLat = marker.getLngLat();
        updateCoordinates(lngLat.lat, lngLat.lng);
        reverseGeocode(lngLat.lat, lngLat.lng);
    });
    
    // Click on map to move marker
    map.on('click', function(e) {
        const { lng, lat } = e.lngLat;
        marker.setLngLat([lng, lat]);
        updateCoordinates(lat, lng);
        reverseGeocode(lat, lng);
    });
    
    // Initialize form fields
    updateCoordinates(defaultLat, defaultLng);
};

function updateCoordinates(lat, lng) {
    document.getElementById('id_latitude').value = lat.toFixed(6);
    document.getElementById('id_longitude').value = lng.toFixed(6);
    document.getElementById('latDisplay').textContent = lat.toFixed(6);
    document.getElementById('lngDisplay').textContent = lng.toFixed(6);
}

function reverseGeocode(lat, lng) {
    fetch(`https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${apiKey}`)
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                const address = data.features[0].properties.formatted;
                const addressField = document.getElementById('id_location');
                if (!addressField.value || confirm('Update address with clicked location?')) {
                    addressField.value = address;
                }
            }
        })
        .catch(error => console.error('Geocoding error:', error));
}

// Address search functionality
const addressField = document.getElementById('id_location');
let searchTimeout;

addressField.addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value;
    
    if (query.length > 10) {
        searchTimeout = setTimeout(() => {
            geocodeAddress(query);
        }, 1000);
    }
});

function geocodeAddress(address) {
    fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(address)}&apiKey=${apiKey}`)
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                const { lat, lon } = data.features[0].properties;
                marker.setLngLat([lon, lat]);
                map.flyTo({ center: [lon, lat], zoom: 14 });
                updateCoordinates(lat, lon);
            }
        })
        .catch(error => console.error('Search error:', error));
}
</script>

{% if form.errors %}
<script>
    alert('Please correct the errors in the form.');
</script>
{% endif %}

{% endblock %}